From 4399a5e80cc9697ecaad636c9f9b2e5df7fe5f5f Mon Sep 17 00:00:00 2001
From: Lukas Rusak <lorusak@gmail.com>
Date: Fri, 13 Oct 2017 10:58:29 -0700
Subject: [PATCH 08/13] fixup! windowing/gbm: add atomic modesetting

---
 xbmc/windowing/gbm/DRMAtomic.cpp | 31 +++++++------------------------
 xbmc/windowing/gbm/DRMUtils.h    |  2 ++
 2 files changed, 9 insertions(+), 24 deletions(-)

diff --git a/xbmc/windowing/gbm/DRMAtomic.cpp b/xbmc/windowing/gbm/DRMAtomic.cpp
index 059d3bd6dc..3f80bd60a9 100644
--- a/xbmc/windowing/gbm/DRMAtomic.cpp
+++ b/xbmc/windowing/gbm/DRMAtomic.cpp
@@ -193,6 +193,12 @@ void CDRMAtomic::FlipPage(CGLContextEGL *pGLContext)
 {
   int flags = DRM_MODE_ATOMIC_NONBLOCK;
 
+  if(m_drm->need_modeset)
+  {
+    flags |= DRM_MODE_ATOMIC_ALLOW_MODESET;
+    m_drm->need_modeset = false;
+  }
+
   pGLContext->CreateGPUFence();
   m_drm->kms_in_fence_fd = pGLContext->FlushFence();
   pGLContext->WaitSyncCPU();
@@ -420,30 +426,7 @@ void CDRMAtomic::DestroyDrmAtomic()
 bool CDRMAtomic::SetVideoMode(RESOLUTION_INFO res)
 {
   CDRMUtils::GetMode(res);
-
-  gbm_surface_release_buffer(m_gbm->surface, m_bo);
-  m_bo = m_next_bo;
-
-  m_next_bo = gbm_surface_lock_front_buffer(m_gbm->surface);
-  if (!m_next_bo)
-  {
-    CLog::Log(LOGERROR, "CDRMAtomic::%s - Failed to lock frontbuffer", __FUNCTION__);
-    return false;
-  }
-
-  m_drm_fb = CDRMUtils::DrmFbGetFromBo(m_next_bo);
-  if (!m_drm_fb)
-  {
-    CLog::Log(LOGERROR, "CDRMAtomic::%s - Failed to get a new FBO", __FUNCTION__);
-    return false;
-  }
-
-  auto ret = DrmAtomicCommit(m_drm_fb->fb_id, DRM_MODE_ATOMIC_ALLOW_MODESET);
-  if (!ret)
-  {
-    CLog::Log(LOGERROR, "CDRMAtomic::%s - failed to commit modeset: %s", __FUNCTION__, strerror(errno));
-    return false;
-  }
+  m_drm->need_modeset = true;
 
   return true;
 }
diff --git a/xbmc/windowing/gbm/DRMUtils.h b/xbmc/windowing/gbm/DRMUtils.h
index aeded42d90..76fcfd7bbf 100644
--- a/xbmc/windowing/gbm/DRMUtils.h
+++ b/xbmc/windowing/gbm/DRMUtils.h
@@ -64,6 +64,8 @@ struct drm
   drmModeModeInfo *mode;
   uint32_t crtc_id;
   uint32_t connector_id;
+
+  bool need_modeset;
 };
 
 struct drm_fb
-- 
2.11.0

