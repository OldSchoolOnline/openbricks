#!/bin/sh

. config/options

get_meta $1

$SCRIPTS/clean $1
$SCRIPTS/unpack $1

cd $PKG_BUILD_DIR

if pkg_uses $1 x11 ; then 
  MESA_DRI="--enable-dri --enable-dri3"
  MESA_GLX="--enable-glx --enable-driglx-direct --enable-glx-tls"
  MESA_EGL_PLATFORMS="--with-platforms=x11,drm"
else
  MESA_DRI="--enable-dri --disable-dri3"
  MESA_GLX="--disable-glx --disable-driglx-direct --disable-glx-tls"
  MESA_EGL_PLATFORMS="--with-platforms=drm"
fi

if pkg_uses $1 gallium3d ; then
  export LLVM_CONFIG="$LIB_PREFIX/bin/llvm-config-host"
  MESA_GALLIUM_LLVM="--enable-llvm --enable-llvm-shared-libs"
else
  MESA_GALLIUM_LLVM="--disable-llvm"
fi

if pkg_uses $1 vdpau ; then
  if pkg_uses $1 x11 ; then
    VDPAU="--enable-vdpau"
  else
    VDPAU="--disable-vdpau"
  fi
else
  VDPAU="--disable-vdpau"
fi

# for vmware driver
XA_CONFIG="--disable-xa"
if pkg_uses $1 xa ]; then
  XA_CONFIG="--enable-xa"
fi

if pkg_uses $1 opengles ; then
  MESA_GLES="--disable-gles1 --enable-gles2"
else
  MESA_GLES="--disable-gles1 --disable-gles2"
fi

DRI_DRIVERS=""
# DRI: Direct Rendering Interface
pkg_uses $1 intel     && DRI_DRIVERS="${DRI_DRIVERS}i915,i965,"
pkg_uses $1 radeon    && DRI_DRIVERS="${DRI_DRIVERS}r200,radeon,"
pkg_uses $1 nouveau   && DRI_DRIVERS="${DRI_DRIVERS}nouveau,"
DRI_DRIVERS="${DRI_DRIVERS}swrast"

# Gallium 3D
if pkg_uses $1 gallium3d; then
  pkg_uses $1 radeon  && GALLIUM_DRIVERS="${GALLIUM_DRIVERS}r300,r600,radeonsi,"
  pkg_uses $1 nouveau && GALLIUM_DRIVERS="${GALLIUM_DRIVERS}nouveau,"
  pkg_uses $1 intel && GALLIUM_DRIVERS="${GALLIUM_DRIVERS}i915,"
  pkg_uses $1 vmwgfx && GALLIUM_DRIVERS="${GALLIUM_DRIVERS}svga,"
  pkg_uses $1 imx && GALLIUM_DRIVERS="${GALLIUM_DRIVERS}etnaviv,imx,"
  GALLIUM_DRIVERS="${GALLIUM_DRIVERS}swrast"
fi

# EGL: Embedded Graphics Library (native platform graphics interface)
if pkg_uses $1 wayland; then
  MESA_EGL_PLATFORMS="--with-platforms=wayland,x11,drm"
fi


setup_toolchain target
# NOCONFIGURE=yes ./autogen.sh

export ac_cv_prog_PYTHON2="$ROOT/$TOOLCHAIN/bin/python"

GCC_NO_GOLD=1 GCC_NO_LTO=1 \
do_configure target \
  --disable-debug \
  --disable-selinux \
  $MESA_DRI \
  $MESA_GLES \
  $MESA_GLX \
  --enable-asm \
  --enable-texture-float \
  --with-dri-drivers="$DRI_DRIVERS" \
  --with-dri-driverdir="$XORG_PATH_DRI" \
  $MESA_EGL_PLATFORMS \
  $XA_CONFIG \
  --with-gallium-drivers="$GALLIUM_DRIVERS" \
  --enable-gbm \
  --disable-nine \
  --disable-xvmc \
  --enable-opengl \
  --disable-omx-bellagio \
  --disable-va \
  --disable-opencl \
  --enable-opencl-icd \
  --disable-gallium-tests \
  --enable-shared-glapi \
  $MESA_GALLIUM_LLVM \
  --enable-driglx-direct \
  --enable-dependency-tracking \
  --disable-gallium-tests \
  $VDPAU \
  --disable-osmesa \
  --disable-gallium-osmesa \

# now build Mesa for target
make
make_install

# hack runtime DRI driver dir path
sed -i "s%^dridriverdir=.*%dridriverdir=/usr/lib/dri\ndrisearchdirs=/usr/lib/dri%" .install/usr/lib/pkgconfig/dri.pc


exit 0

