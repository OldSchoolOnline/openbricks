#!/bin/sh

. config/options
get_meta $1

cd $PKG_BUILD_DIR

if pkg_uses $1 wifi; then
  WIFI_CONFIG="--enable-wifi"
else
  WIFI_CONFIG="--disable-wifi"
fi

if pkg_uses $1 bluetooth; then
  BLUETOOTH_CONFIG="--enable-bluetooth"
else
  BLUETOOTH_CONFIG="--disable-bluetooth"
fi

if pkg_uses $1 client; then
  CLIENT_CONFIG="--enable-client"
else
  CLIENT_CONFIG="--disable-client"
fi

[ -e ./bootstrap ] && ./bootstrap

do_configure \
            --enable-ethernet \
            $WIFI_CONFIG \
            $BLUETOOTH_CONFIG \
            $CLIENT_CONFIG \
            --disable-hh2serial-gps \
            --disable-ofono \
            --disable-openconnect \
            --disable-openvpn \
            --disable-vpnc \
            --disable-l2tp \
            --disable-pptp \
            --disable-iwd \
            --disable-iospm \
            --enable-test \
            --disable-tist \
            --disable-nmcompat \
            --disable-polkit \
            --enable-loopback \
            --disable-tools \
            --enable-datafiles \
            --with-dbusconfdir=/etc

make
make_install

if pkg_uses $1 client; then
  mkdir -p .install/usr/bin
  cp -P client/connmanctl .install/usr/bin
  strip_bins .install/usr/bin
fi

mkdir -p .install/etc/connman
cp -P $ROOT/$PACKAGES/$PKG_SECTION/$1/config/main.conf .install/etc/connman

# copy our scripts
cp -P $ROOT/$PACKAGES/$PKG_SECTION/$1/scripts/connman-parse-configuration* .install/usr/lib/connman

# remove original unit file (we use our own)
rm -f .install/lib/systemd/system/connman.service

mkdir -p .install/lib/systemd/system/multi-user.target.wants
ln -s ../network.target .install/lib/systemd/system/multi-user.target.wants

mkdir -p .install/lib/systemd/system/network-online.target.wants
ln -s ../connman-wait-online.service .install/lib/systemd/system/network-online.target.wants

exit 0
